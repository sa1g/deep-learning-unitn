<mxfile host="Electron" modified="2024-08-09T14:21:35.229Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/24.6.4 Chrome/124.0.6367.207 Electron/30.0.6 Safari/537.36" etag="Hpg_xV_UWLWLwl8qW6KA" version="24.6.4" type="device">
  <diagram name="Pagina-1" id="B5XzhxoZpN2iwp-922ps">
    <mxGraphModel dx="4738" dy="6784" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="YFvvwDukNjqFWr-gQH4H-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.44;exitDx=425;exitDy=0;exitPerimeter=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" parent="1" source="7ocgcldPEU29jeWmDTYm-2" target="YFvvwDukNjqFWr-gQH4H-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7ocgcldPEU29jeWmDTYm-2" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 16.8px;line-height: 22px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;CoCoOpCLIP&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;criterion&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;cosine&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;ViT-L/14&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;a_photo_of_a&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;end&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;load&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;download_root&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;DOWNLOAD_ROOT&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;image_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;visual&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;TextEncoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;data&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# prompt tuning&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;CoCoOpPromptLearner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;criterion&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;criterion&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div style=&quot;font-size: 16.8px; line-height: 22px;&quot;&gt;&lt;div&gt;    &lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #189022;&quot;&gt;forward&lt;/span&gt;(&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;,&lt;/span&gt; &lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;input&lt;/span&gt;)&lt;span style=&quot;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;        &lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;isinstance&lt;/span&gt;(&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;,&lt;/span&gt; &lt;span style=&quot;color: #0094f0;&quot;&gt;Tuple&lt;/span&gt;)&lt;span style=&quot;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;            image_features&lt;span style=&quot;font-weight: bold;&quot;&gt;,&lt;/span&gt; ctx &lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;/div&gt;&lt;div&gt;            &lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward_ctx&lt;/span&gt;(image_features&lt;span style=&quot;font-weight: bold;&quot;&gt;,&lt;/span&gt; ctx)&lt;/div&gt;&lt;div&gt;        &lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;            &lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;inference&lt;/span&gt;(&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;points=[[0,0,0,0,0],[0,0.25,0,0,0],[0,0.5,0,0,0],[0,0.75,0,0,0],[0,1,0,0,0],[0.21,0.83,0,0,0],[0.25,0,0,0,0],[0.25,1,0,0,0],[0.5,0,0,0,0],[0.5,1,0,0,0],[0.75,0,0,0,0],[0.75,0.92,0,0,0],[0.75,1,0,0,0],[0.84,0.32,0,0,0],[1,0,0,0,0],[1,0.25,0,0,0],[1,0.44,0,425,0],[1,0.5,0,0,0],[1,0.75,0,0,0],[1,1,0,0,0]];fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-140" y="60" width="560" height="470" as="geometry" />
        </mxCell>
        <UserObject label="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 16.8px;line-height: 22px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# [N, n_cls, 1, dim]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# expand `ctx` n_cls times&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;permute&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# ctx = ctx.reshape(N, self.prompt_generator.n_cls, -1, self.prompt_generator.ctx_dim)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# full_n_ctx = prompts.size()[-2]&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;reshape&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;reshape&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;exp&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;squeeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 16.8px;line-height: 22px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# [N, n_cls, 1, dim]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# expand `ctx` n_cls times&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;permute&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# ctx = ctx.reshape(N, self.prompt_generator.n_cls, -1, self.prompt_generator.ctx_dim)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# full_n_ctx = prompts.size()[-2]&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;reshape&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;reshape&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;N&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;exp&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;squeeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="7ocgcldPEU29jeWmDTYm-3">
          <mxCell style="text;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
            <mxGeometry x="-1170" y="670" width="1100" height="770" as="geometry" />
          </mxCell>
        </UserObject>
        <mxCell id="7ocgcldPEU29jeWmDTYm-4" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 16.8px;line-height: 22px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;inference&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;label&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;exp&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;image_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_generator&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; []&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pts_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;imf_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;zip&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pts_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;l_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;imf_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;append&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;l_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;stack&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry y="610" width="910" height="420" as="geometry" />
        </mxCell>
        <mxCell id="7ocgcldPEU29jeWmDTYm-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.21;exitY=0.83;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="7ocgcldPEU29jeWmDTYm-2" target="7ocgcldPEU29jeWmDTYm-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7ocgcldPEU29jeWmDTYm-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0.92;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="7ocgcldPEU29jeWmDTYm-2" target="7ocgcldPEU29jeWmDTYm-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <UserObject label="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 16.8px;line-height: 22px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;TextEncoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;transformer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;transformer&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;positional_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;positional_embedding&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ln_final&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_projection&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_projection&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;positional_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;permute&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# NLD -&amp;gt; LND&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;transformer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;permute&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# LND -&amp;gt; NLD&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# x.shape = [batch_size, n_ctx, transformer.width]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# take features from the eot embedding (eot_token is the highest number in each sequence)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;arange&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;shape[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;argmax&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_projection&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 16.8px;line-height: 22px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;TextEncoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;transformer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;transformer&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;positional_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;positional_embedding&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ln_final&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_projection&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_projection&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;positional_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;permute&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# NLD -&amp;gt; LND&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;transformer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;permute&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# LND -&amp;gt; NLD&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# x.shape = [batch_size, n_ctx, transformer.width]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# take features from the eot embedding (eot_token is the highest number in each sequence)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;arange&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;shape[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;argmax&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_projection&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;x&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="7ocgcldPEU29jeWmDTYm-9">
          <mxCell style="text;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
            <mxGeometry x="730" y="-460" width="1030" height="490" as="geometry" />
          </mxCell>
        </UserObject>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.84;exitY=0.32;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="7ocgcldPEU29jeWmDTYm-2" target="7ocgcldPEU29jeWmDTYm-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-2" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;CoCoOpPromptLearner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;a_photo_of_a&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;end&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;visual&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;conv1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;device&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;shape[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embed_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_projection&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;shape[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# use given words to initialize context vectors&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Initializing the contect with given words: [&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{}&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;]&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;format&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;split&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Random initialization: initializing a generic context&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;join&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&#39;Initial context: &quot;&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;Number of context words (tokens): &lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Parameter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;meta_net&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Sequential&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;OrderedDict&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            (&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;linear1&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Linear&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embed_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embed_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            (&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;relu&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;ReLU&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;inplace&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            (&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;linear2&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Linear&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embed_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        ]))&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_tokenizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;encode&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# These token vectors will be saved when in save_model(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# but they should be ignored in load_model() as we want to use&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# those computed using the current class names&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_prefix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# SOS&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_suffix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# CLS, EOS&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# torch.Tensor&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1130" y="400" width="910" height="1140" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-4" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;test_time_adapt_eval&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;val_loader&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;model_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;optim_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;batch_time&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;AverageMeter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;Time&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;:6.3f&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;&quot;&gt;Summary&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;NONE&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;AverageMeter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;Acc@1&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;:6.2f&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;&quot;&gt;Summary&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;AVERAGE&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top5&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;AverageMeter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;Acc@5&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;:6.2f&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;&quot;&gt;Summary&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;AVERAGE&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;progress&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;ProgressMeter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;val_loader&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;batch_time&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top5&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;Test: &#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# reset model and switch to evaluate mode&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;eval&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# no need to reset cocoop because it&#39;s fixed&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;reset&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;end&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;time&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;time&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;target&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;enumerate&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;val_loader&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;assert&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;gpu &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;isinstance&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;list&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;k&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;range&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;k&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;k&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cuda&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;gpu&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;non_blocking&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# when using ImageNet Sampler as the dataset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;assert&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;squeeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cuda&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;gpu&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;non_blocking&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;target&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;target&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cuda&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;gpu&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;non_blocking&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tpt&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# reset the tunable prompt to its initial state&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# no need to reset cocoop because it&#39;s fixed&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tta_steps &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;reset&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;load_state_dict&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optim_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;test_time_tuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cuda&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;amp&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;autocast&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;gen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;images&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tpt)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;test_time_tuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# The actual inference goes here&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tpt&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;unsqueeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cuda&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;amp&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;autocast&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# measure accuracy and record loss&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;acc1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;acc5&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;accuracy&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;target&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;topk&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;5&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;update&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;acc1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top5&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;update&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;acc5&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# measure elapsed time&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;batch_time&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;update&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;time&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;time&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;end&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;end&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;time&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;time&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;%&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;print_freq &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;progress&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;display&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;progress&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;display_summary&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;avg&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;top5&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;avg&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;points=[[0,0,0,0,0],[0,0.25,0,0,0],[0,0.5,0,0,0],[0,0.75,0,0,0],[0,1,0,0,0],[0.08,0.52,0,0,0],[0.1,0.6,0,0,0],[0.25,0,0,0,0],[0.25,1,0,0,0],[0.35,0.5,0,0,0],[0.45,0.76,0,0,0],[0.5,0,0,0,0],[0.5,1,0,0,0],[0.64,0.73,0,0,0],[0.75,0,0,0,0],[0.75,1,0,0,0],[1,0,0,0,0],[1,0.25,0,0,0],[1,0.5,0,0,0],[1,0.75,0,0,0],[1,1,0,0,0]];" parent="1" vertex="1">
          <mxGeometry x="-1770" y="-1800" width="850" height="1450" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.03;exitY=0.29;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="YFvvwDukNjqFWr-gQH4H-5" target="YFvvwDukNjqFWr-gQH4H-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-22" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.94;exitY=0.18;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" parent="1" source="YFvvwDukNjqFWr-gQH4H-5" target="YFvvwDukNjqFWr-gQH4H-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-5" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;ClipTestTimeTuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;criterion&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;cosine&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;ViT-L/14&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;end&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;False&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;ClipTestTimeTuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;load&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;download_root&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;DOWNLOAD_ROOT&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;image_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;visual&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;TextEncoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;data&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# prompt tuning&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_learner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;PromptLearner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;criterion&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;criterion&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;property&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;image_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;conv1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# restore the initial state of the prompt_learner (tunable prompt)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_learner&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset_classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_learner&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset_classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;get_text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; []&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_learner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_learner&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;t_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;text_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;append&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;t_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;t_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;stack&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;mean&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;inference&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;image_encoder&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;image&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;get_text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;/&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;norm&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;keepdim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;exp&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logit_scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;text_features&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;t&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;logits&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;input&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;isinstance&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;Tuple&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;view_0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;view_1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;view_2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;contrast_prompt_tuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;view_0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;view_1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;view_2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;directional_prompt_tuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;inference&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;input&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;points=[[0,0,0,0,0],[0,0.25,0,0,0],[0,0.5,0,0,0],[0,0.75,0,0,0],[0,1,0,0,0],[0.03,0.29,0,0,0],[0.25,0,0,0,0],[0.25,1,0,0,0],[0.5,0,0,0,0],[0.5,1,0,0,0],[0.75,0,0,0,0],[0.75,1,0,0,0],[0.94,0.18,0,0,0],[1,0,0,0,0],[1,0.25,0,0,0],[1,0.5,0,0,0],[1,0.75,0,0,0],[1,1,0,0,0]];fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-915" y="-4410" width="1010" height="1070" as="geometry" />
        </mxCell>
        <mxCell id="tcSdG7Ohk_E-uoe9hiWd-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="YFvvwDukNjqFWr-gQH4H-6" target="YFvvwDukNjqFWr-gQH4H-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-6" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;get_coop&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;clip_arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;test_set&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;False&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;test_set&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;fewshot_datasets&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;eval&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{}&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;_classes&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;format&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;test_set&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;lower&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;test_set&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;bongard&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;X&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;X&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;True&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;False&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;imagenet_classes&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;ClipTestTimeTuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;model&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-970" y="-4810" width="740" height="310" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-19" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;dashed=1;" parent="1" source="YFvvwDukNjqFWr-gQH4H-7" target="YFvvwDukNjqFWr-gQH4H-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <UserObject label="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;PromptLearner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;end&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;False&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;learned_cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;visual&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;conv1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;device&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;shape[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;batch_size&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# self.ctx, prompt_prefix = self.reset_prompt(ctx_dim, ctx_init, clip_model)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# use given words to initialize context vectors&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Initializing the contect with given words: [&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{}&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;]&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;format&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;[CLS]&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_list&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;split&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_list&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;index&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;[CLS]&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;[CLS] &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;middle&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;split_idx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;split&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Random initialization: initializing a generic context&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;join&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&#39;Initial context: &quot;&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;Number of context words (tokens): &lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# batch-wise prompt tuning for test-time adaptation&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;#(N, L, D)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Parameter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_tokenizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;encode&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Random initialization: initializing a learnable class token&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# assume each learnable cls_token is only 1 word&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Parameter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# These token vectors will be saved when in save_model(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# but they should be ignored in load_model() as we want to use&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# those computed using the current class names&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_prefix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# SOS&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_suffix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# ..., EOS&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_suffix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# CLS, EOS&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# torch.Tensor&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;&quot;&gt;PromptLearner&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-style: italic;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;Module&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;16&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;end&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;False&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #00bdd6;&quot;&gt;__init__&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;learned_cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;visual&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;conv1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;device&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ln_final&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;weight&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;shape[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;batch_size&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# self.ctx, prompt_prefix = self.reset_prompt(ctx_dim, ctx_init, clip_model)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# use given words to initialize context vectors&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Initializing the contect with given words: [&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{}&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;]&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;format&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&#39;[CLS]&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_list&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;split&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_list&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;index&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;[CLS]&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;[CLS] &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;middle&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;split_idx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;split&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Random initialization: initializing a generic context&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;join&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&#39;Initial context: &quot;&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;&#39;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;Number of context words (tokens): &lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #009456;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# batch-wise prompt tuning for test-time adaptation&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;#(N, L, D)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Parameter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_tokenizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;encode&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;Random initialization: initializing a learnable class token&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# assume each learnable cls_token is only 1 word&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;Parameter&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;clip_model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# These token vectors will be saved when in save_model(),&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# but they should be ignored in load_model() as we want to use&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# those computed using the current class names&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_prefix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# SOS&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_suffix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# ..., EOS&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;register_buffer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;token_suffix&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# CLS, EOS&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# torch.Tensor&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;ctx_position&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;n_cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;n_ctx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init_state&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;copy_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;copy_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset_classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_tokenizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;encode&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# assume each learnable cls_token is only 1 word&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;TODO&lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;: re-init the cls parameters&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# self.cls = nn.Parameter(cls_vectors) # to be optimized&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;load&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;download_root&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;DOWNLOAD_ROOT&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# CLS, EOS&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# the init will be used when computing CLIP directional loss&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;unsqueeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;unsqueeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# This way only works for single-gpu setting (could pass batch size as an argument for forward())&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;assert&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, n_ctx, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, n_ctx, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;middle&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;TODO&lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;: to work with a batch of prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# split the ctx at the position of [CLS] in `ctx_init`&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; []&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;range&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, n_ctx//2, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, name_len, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, n_ctx//2, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;append&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;front&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; []&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;range&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, name_len, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, n_ctx, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;append&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;ValueError&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="YFvvwDukNjqFWr-gQH4H-7">
          <mxCell style="text;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
            <mxGeometry x="520" y="-4560" width="1190" height="1650" as="geometry" />
          </mxCell>
        </UserObject>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;dashed=1;" parent="1" source="YFvvwDukNjqFWr-gQH4H-9" target="YFvvwDukNjqFWr-gQH4H-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-21" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.25;exitDx=0;exitDy=0;dashed=1;" parent="1" source="YFvvwDukNjqFWr-gQH4H-9" target="YFvvwDukNjqFWr-gQH4H-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-9" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;forward&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# the init will be used when computing CLIP directional loss&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;init&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;() &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;unsqueeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;unsqueeze&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;expand&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# This way only works for single-gpu setting (could pass batch size as an argument for forward())&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;repeat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;batch_size&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;assert&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, n_ctx, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, n_ctx, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (n_cls, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=-&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;middle&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;TODO&lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;: to work with a batch of prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;split_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# split the ctx at the position of [CLS] in `ctx_init`&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;2&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; []&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;range&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half2&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;half_n_ctx&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, n_ctx//2, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;      &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, name_len, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i_half2&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, n_ctx//2, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;append&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;elif&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;class_token_position&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;front&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; []&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;range&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_len&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;i&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    [&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prefix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, 1, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;class_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;   &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, name_len, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;     &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, n_ctx, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;suffix_i&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# (1, *, dim)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    ]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                    &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;append&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompt&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dim&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;ValueError&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-570" y="-3330" width="960" height="1790" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-10" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_init_state&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;copy_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;ctx_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# to be optimized&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;copy_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="-510" y="-1490" width="490" height="140" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.35;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="YFvvwDukNjqFWr-gQH4H-4" target="YFvvwDukNjqFWr-gQH4H-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <UserObject label="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset_classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_tokenizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;encode&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# assume each learnable cls_token is only 1 word&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;TODO&lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;: re-init the cls parameters&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# self.cls = nn.Parameter(cls_vectors) # to be optimized&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;load&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;download_root&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;DOWNLOAD_ROOT&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# CLS, EOS&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;reset_classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;font-weight: bold;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;learned_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;replace&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;_&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #0095a8;font-style: italic;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_tokenizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #189022;&quot;&gt;encode&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;empty&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_cls&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;ctx_dim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# assume each learnable cls_token is only 1 word&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;nn&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;normal_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0.02&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;X&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; [&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;prompt_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot; &quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_token&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #00b368;&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;TODO&lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;: re-init the cls parameters&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# self.cls = nn.Parameter(cls_vectors) # to be optimized&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;cls_init_state&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cls_vectors&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;detach&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;clone&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;cat&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;tokenize&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;])&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;to&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;load&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;arch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;device&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;download_root&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;DOWNLOAD_ROOT&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;no_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;clip&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;token_embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;type&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;dtype&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_prefix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;token_suffix&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;embedding&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;n_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]  &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# CLS, EOS&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;name_lens&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;name_lens&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tokenized_prompts&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #e64100;font-style: italic;&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #a88c00;&quot;&gt;classnames&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;classnames&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="YFvvwDukNjqFWr-gQH4H-12">
          <mxCell style="text;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
            <mxGeometry x="-2120" y="-3230" width="1150" height="560" as="geometry" />
          </mxCell>
        </UserObject>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.81;exitY=0.59;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="YFvvwDukNjqFWr-gQH4H-14" target="YFvvwDukNjqFWr-gQH4H-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-14" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;test_time_tuning&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;inputs&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;inputs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;requires_grad &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;True&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;optim&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;AdamW&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;([&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;lr)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;selected_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;j&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;range&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;tta_steps)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;with&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cuda&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;amp&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;autocast&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;((&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;image_feature&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;model&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;inputs&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;selected_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;selected_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;selected_idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;select_confident_samples&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;selection_p)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;loss&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;avg_entropy&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;output&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;zero_grad&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# compute gradient and do SGD step&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;scale&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;loss&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;backward&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #8ca6a6;&quot;&gt;# Unscales the gradients of optimizer&#39;s assigned params in-place&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;step&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;scaler&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;update&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;args&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;cocoop&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;pgen_ctx&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;points=[[0,0,0,0,0],[0,0.25,0,0,0],[0,0.5,0,0,0],[0,0.75,0,0,0],[0,1,0,0,0],[0.25,0,0,0,0],[0.25,1,0,0,0],[0.5,0,0,0,0],[0.5,1,0,0,0],[0.75,0,0,0,0],[0.75,1,0,0,0],[0.81,0.59,0,0,0],[1,0,0,0,0],[1,0.25,0,0,0],[1,0.5,0,0,0],[1,0.75,0,0,0],[1,1,0,0,0]];" parent="1" vertex="1">
          <mxGeometry x="-2660" y="-1220" width="770" height="610" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.08;exitY=0.52;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="YFvvwDukNjqFWr-gQH4H-4" target="YFvvwDukNjqFWr-gQH4H-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.1;exitY=0.6;exitDx=0;exitDy=0;exitPerimeter=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="YFvvwDukNjqFWr-gQH4H-4" target="YFvvwDukNjqFWr-gQH4H-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="YFvvwDukNjqFWr-gQH4H-17" value="&lt;div style=&quot;color: #004d57;background-color: #fef9f0;font-family: &#39;Fira Code&#39;,Hack, &#39;Droid Sans Mono&#39;, &#39;Fira Mono&#39;, OpenDyslexic3, &#39;monospace&#39;, monospace, &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e64100;font-weight: bold;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;select_confident_samples&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;top&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;batch_entropy&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;softmax&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;log_softmax&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;sum&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b3694d;font-weight: bold;&quot;&gt;torch&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;argsort&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;batch_entropy&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;font-weight: bold;&quot;&gt;descending&lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;False&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)[&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #0094f0;font-style: italic;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;batch_entropy&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #0095a8;&quot;&gt;size&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;()[&lt;/span&gt;&lt;span style=&quot;color: #5842ff;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;top&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;)]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ff5792;font-weight: bold;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #fa8900;&quot;&gt;logits&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;idx&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #004d57;font-weight: bold;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #004d57;&quot;&gt;idx&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-2680" y="-570" width="800" height="100" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
